<!DOCTYPE html>
<html lang="bn">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Ambulance Search</title>
	<style>
		:root{ --muted:#e5e7eb; }
		*{box-sizing:border-box}
		html,body{height:100%}
		body{
			margin:0;font-family: "Noto Sans Bengali", system-ui, -apple-system, Segoe UI, Roboto, Arial;
			color:#fff; display:grid; place-items:start center; padding:24px; overflow:hidden;
			background: linear-gradient(-45deg,#06b6d4,#16a34a,#2563eb); background-size:400% 400%; animation:gradientBG 12s ease-in-out infinite;
		 overflow: auto;
		}
		@keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
		#leaf-container{ position: fixed; inset:0; pointer-events:none; z-index:1 }

		.wrap{ width:100%; max-width:920px; margin-top:100px; z-index:3 }
		.card{ backdrop-filter: blur(6px); background: rgba(0,0,0,0.55); border-radius:16px; padding:22px; box-shadow:0 18px 40px rgba(0,0,0,.35); }
		h1{ margin:6px 0 8px; font-size:24px }
		.controls{ display:flex; gap:12px; flex-wrap:wrap; margin-bottom:14px }
		select, button{ padding:12px 14px; font-size:16px; border-radius:10px; border:none }
		select{ background:#fff; color:#000; min-width:160px }
		button{ background:#0284c7; color:#fff; font-weight:700; cursor:pointer }
		#anyBtn{ background:#16a34a }
		.results{ margin-top:12px }
		.item{ background: rgba(255,255,255,0.04); padding:12px; border-radius:10px; margin-bottom:10px; }
		.item h3{ margin:0 0 6px; font-size:18px }
		.item p{ margin:0; opacity:.9; font-size:14px }
		.muted{ color:var(--muted); font-size:13px }
		.empty{ padding:18px; text-align:center; color:var(--muted) }
		.loading{ text-align:center; padding:20px; color:var(--muted) }
		.contact-btn{ 
			background:#2563eb; color:white; border:none; padding:8px 16px; 
			border-radius:6px; cursor:pointer; margin-top:8px; font-size:14px;
		}
	</style>
</head>
<body>
	<div id="leaf-container" aria-hidden="true"></div>
	<main class="wrap">
		<section class="card" aria-labelledby="searchTitle">
			<h1 id="searchTitle">Ambulance Search by Service Area</h1>
			<div class="controls">
				<label for="area" class="sr-only">Service Area</label>
				<select id="area" aria-label="Select service area">
					<option value="">-- Select Area --</option>
					<option value="Dhaka">Dhaka</option>
					<option value="Chattogram">Chattogram</option>
					<option value="Rajshahi">Rajshahi</option>
					<option value="Khulna">Khulna</option>
					<option value="Sylhet">Sylhet</option>
					<option value="Barishal">Barishal</option>
					<option value="Rangpur">Rangpur</option>
					<option value="Mymensingh">Mymensingh</option>
				</select>
				<button id="searchBtn">Search</button>
				<button id="anyBtn">Show All Available</button>
			</div>
			<div id="results" class="results" aria-live="polite"></div>
		</section>
	</main>

	<script type="module">
		import { findDriversByArea, auth, onAuthChanged } from './firebase.js';

		// Floating LEAVES background (10 leaves)
		(function(){
			const leafContainer = document.getElementById('leaf-container');
			const svg = `<svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M24 4C18 16 4 20 4 32C4 40 16 44 24 44C32 44 44 40 44 32C44 20 30 16 24 4Z" 
				fill="#f59e0b" stroke="#b45309" stroke-width="1.2"/>
				<path d="M24 44C24 32 24 20 24 4" stroke="#b45309" stroke-width="0.9" stroke-linecap="round"/>
			</svg>`;
			function rand(a,b){return Math.random()*(b-a)+a}
			for(let i=0;i<10;i++){
				const el = document.createElement('div');
				el.style.position='absolute';
				el.style.left = rand(0,95)+'vw';
				el.style.top = rand(-25, -5)+'vh';
				const size = rand(28,64);
				el.style.width = size+'px'; el.style.height = size+'px';
				el.style.opacity = String(rand(0.8,1));
				el.style.transform = `rotate(${rand(-30,30)}deg)`;
				el.innerHTML = svg;
				const dur = rand(6,12);
				el.style.transition = `top ${dur}s linear, left ${dur}s ease-in-out, transform ${dur}s linear, opacity ${dur}s linear`;
				setTimeout(()=>{
					el.style.top = '110vh';
					el.style.left = rand(-10,105)+'vw';
					el.style.transform = `rotate(${rand(90,720)}deg) scale(${rand(0.7,1.2)})`;
					el.style.opacity = '0';
				}, rand(100,1200));
				setInterval(()=>{
					el.style.transition = 'none';
					el.style.top = rand(-30,-5)+'vh';
					el.style.left = rand(0,95)+'vw';
					el.style.opacity = String(rand(0.8,1));
					el.style.transform = `rotate(${rand(-30,30)}deg)`;
					void el.offsetWidth;
					el.style.transition = `top ${dur}s linear, left ${dur}s ease-in-out, transform ${dur}s linear, opacity ${dur}s linear`;
					setTimeout(()=>{
						el.style.top = '110vh';
						el.style.left = rand(-10,105)+'vw';
						el.style.transform = `rotate(${rand(90,720)}deg) scale(${rand(0.7,1.2)})`;
						el.style.opacity = '0';
					},50);
				}, (dur+rand(2,6))*1000);
				leafContainer.appendChild(el);
			}
		})();

		// Search logic
		const resultsEl = document.getElementById('results');
		const areaSelect = document.getElementById('area');
		const searchBtn = document.getElementById('searchBtn');
		const anyBtn = document.getElementById('anyBtn');

		// Check authentication
		onAuthChanged((user) => {
			if (!user) {
				window.location.href = 'driver_login.html';
				return;
			}
		});

		searchBtn.addEventListener('click', runSearch);
		anyBtn.addEventListener('click', () => { 
			areaSelect.value=''; 
			runSearch() 
		});

		async function runSearch(){
			const area = areaSelect.value;
			
			resultsEl.innerHTML = '<div class="loading">Searching for ambulances...</div>';
			
			try {
				const drivers = await findDriversByArea(area);
				renderDrivers(drivers);
			} catch (error) {
				console.error('Search error:', error);
				resultsEl.innerHTML = '<div class="empty">Error searching for ambulances. Please try again.</div>';
			}
		}

		function renderDrivers(drivers){
			if(!drivers || drivers.length === 0){ 
				resultsEl.innerHTML = '<div class="empty">No ambulances found for the selected area.</div>'; 
				return;
			}
			
			resultsEl.innerHTML = '';
			drivers.forEach(driver => {
				const el = document.createElement('div'); 
				el.className = 'item';
				
				const vehicleInfo = driver.vehicle ? 
					`<p>üöë Vehicle: ${escapeHtml(driver.vehicle)}</p>` : '';
				
				const experienceInfo = driver.experience ? 
					`<p class="muted">Experience: ${driver.experience} years</p>` : '';

				el.innerHTML = `
					<h3>${escapeHtml(driver.fullName || 'Driver')} 
						<span class="muted">(${escapeHtml(driver.area)})</span>
					</h3>
					<p>üìû ${escapeHtml(driver.mobile || 'Phone not provided')}</p>
					<p>üìç ${escapeHtml(driver.address || 'Address not provided')}</p>
					${vehicleInfo}
					${experienceInfo}
					<p style="margin-top:8px"><strong style="color:#34d399">Available Now</strong></p>
					<button class="contact-btn" onclick="contactDriver('${escapeHtml(driver.mobile)}', '${escapeHtml(driver.fullName)}')">
						üìû Call Ambulance
					</button>
				`;
				resultsEl.appendChild(el);
			});
		}

		function escapeHtml(s){ 
			return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); 
		}

		// Make contactDriver function available globally
		window.contactDriver = function(phone, name) {
			if (phone && phone !== 'Phone not provided') {
				if (confirm(`Do you want to call ${name} at ${phone}?`)) {
					window.location.href = `tel:${phone}`;
				}
			} else {
				alert('Phone number not available for this driver.');
			}
		};

		// Initial load: show all available drivers
		runSearch();
	</script>
</body>
</html>