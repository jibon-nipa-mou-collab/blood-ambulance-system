<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donor Dashboard</title>
  <style>
    body {
      font-family: "Noto Sans Bengali", Arial, sans-serif;
      margin: 0;
      color: white;
      overflow: hidden;
    }
    .animated-bg{ 
      position:fixed; 
      inset:0; 
      z-index:-2; 
      background:linear-gradient(270deg,#ff4d4d,#22c55e,#3b82f6); 
      background-size:600% 600%; 
      animation:rgbShift 10s ease infinite;
    }
    @keyframes rgbShift{ 
      0%{background-position:0% 50%} 
      50%{background-position:100% 50%} 
      100%{background-position:0% 50%} 
    }
    #leaf-container{ 
      position:fixed; 
      inset:0; 
      pointer-events:none; 
      z-index:-1; 
      overflow:hidden;
    }

    .dashboard {
      background: rgba(0,0,0,0.7);
      margin: 80px auto 40px;
      padding: 30px 40px;
      border-radius: 15px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.5);
      text-align: center;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .user-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #60a5fa, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
      border: 3px solid rgba(255,255,255,0.2);
    }

    .user-details {
      text-align: left;
    }

    .user-name {
      font-size: 20px;
      font-weight: bold;
      margin: 0;
      color: white;
    }

    .user-email {
      font-size: 14px;
      color: #cbd5e1;
      margin: 5px 0 0 0;
    }

    .user-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 25px 0;
      padding: 20px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .stat-item {
      text-align: center;
      padding: 15px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #60a5fa;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #cbd5e1;
    }

    .dashboard h1 {
      margin-bottom: 15px;
      font-size: 28px;
      color: white;
    }

    .dashboard p {
      color: #e5e7eb;
      margin-bottom: 25px;
      font-size: 16px;
    }

    .buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 25px;
    }

    .btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      color: white;
      background: linear-gradient(135deg, #16a34a, #15803d);
      transition: all 0.3s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3);
    }

    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(22, 163, 74, 0.4);
      background: linear-gradient(135deg, #15803d, #166534);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #1d4ed8, #1e40af);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }

    .btn-profile {
      background: linear-gradient(135deg, #7c3aed, #6d28d9);
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
    }

    .btn-profile:hover {
      background: linear-gradient(135deg, #6d28d9, #5b21b6);
      box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
    }

    .btn-icon {
      font-size: 20px;
    }

    .logout-section {
      margin-top: 35px;
      padding-top: 25px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .logout-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      border: 1px solid rgba(239, 68, 68, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      color: #fecaca;
      text-decoration: none;
    }

    .availability-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-top: 10px;
    }

    .available {
      background: rgba(34, 197, 94, 0.2);
      color: #86efac;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .unavailable {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .available .status-dot {
      background: #86efac;
    }

    .unavailable .status-dot {
      background: #fca5a5;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #cbd5e1;
    }

    @media (max-width: 768px) {
      .dashboard {
        margin: 60px auto 20px;
        padding: 20px;
      }
      
      .user-header {
        flex-direction: column;
        text-align: center;
      }
      
      .user-details {
        text-align: center;
      }
      
      .buttons {
        grid-template-columns: 1fr;
      }
      
      .btn {
        padding: 18px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      .user-stats {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .stat-item {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="animated-bg" aria-hidden="true"></div>
  <div id="leaf-container" aria-hidden="true"></div>
  
  <div class="dashboard">
    <!-- User Header Section -->
    <div class="user-header">
      <div class="user-avatar" id="userAvatar">
        <span id="avatarInitials">U</span>
      </div>
      <div class="user-details">
        <h2 class="user-name" id="userName">Loading...</h2>
        <p class="user-email" id="userEmail">Loading...</p>
        <div class="availability-status available" id="availabilityStatus">
          <span class="status-dot"></span>
          <span id="statusText">Available for Donation</span>
        </div>
      </div>
    </div>

    <!-- User Stats -->
    <div class="user-stats">
      <div class="stat-item">
        <div class="stat-value" id="donationCount">0</div>
        <div class="stat-label">Total Donations</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="bloodGroup">--</div>
        <div class="stat-label">Blood Group</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="memberSince">Today</div>
        <div class="stat-label">Member Since</div>
      </div>
    </div>

    <h1>Donor Dashboard</h1>
    <p>You have successfully logged in. Please choose your option</p>

    <!-- Action Buttons -->
    <div class="buttons">
      <a href="donor_search.html" class="btn">
        <span class="btn-icon">ü©∏</span>
        Blood Donor Search
      </a>
      <a href="driver_search.html" class="btn btn-secondary">
        <span class="btn-icon">üöë</span>
        Ambulance Search
      </a>
      <a href="donor_profile.html" class="btn btn-profile">
        <span class="btn-icon">üë§</span>
        My Profile
      </a>
    </div>

    <!-- Quick Actions -->
    <div class="buttons" style="margin-top: 15px;">
      <a href="donor_profile_edit.html" class="btn" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <span class="btn-icon">‚úèÔ∏è</span>
        Edit Profile
      </a>
      <button class="btn" id="toggleAvailabilityBtn" style="background: linear-gradient(135deg, #059669, #047857);">
        <span class="btn-icon">üîÑ</span>
        Toggle Availability
      </button>
    </div>

    <!-- Logout Section -->
    <div class="logout-section">
      <button id="logoutBtn" class="logout-btn">
        <span>üö™</span>
        Logout and Back to Home Page
      </button>
    </div>
  </div>

  <script type="module">
    import { 
      onAuthChanged, 
      logoutUser, 
      getUserProfile, 
      updateAvailability,
      auth 
    } from './firebase.js';
    
    // Leaves animation
    (function(){
      const leafContainer = document.getElementById('leaf-container');
      const svg = `<svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M24 4C18 16 4 20 4 32C4 40 16 44 24 44C32 44 44 40 44 32C44 20 30 16 24 4Z" 
              fill="#f59e0b" stroke="#b45309" stroke-width="1.2"/>
        <path d="M24 44C24 32 24 20 24 4" stroke="#b45309" stroke-width="0.9" stroke-linecap="round"/>
      </svg>`;
      
      function rand(a,b){return Math.random()*(b-a)+a}
      
      for(let i=0;i<10;i++){
        const el = document.createElement('div');
        el.style.position='absolute';
        el.style.left = rand(0,95)+'vw';
        el.style.top = rand(-25, -5)+'vh';
        const size = rand(28,64);
        el.style.width = size+'px'; 
        el.style.height = size+'px';
        el.style.opacity = String(rand(0.8,1));
        el.style.transform = `rotate(${rand(-30,30)}deg)`;
        el.innerHTML = svg;
        const dur = rand(6,12);
        el.style.transition = `top ${dur}s linear, left ${dur}s ease-in-out, transform ${dur}s linear, opacity ${dur}s linear`;
        
        setTimeout(()=>{
          el.style.top = '110vh';
          el.style.left = rand(-10,105)+'vw';
          el.style.transform = `rotate(${rand(90,720)}deg) scale(${rand(0.7,1.2)})`;
          el.style.opacity = '0';
        }, rand(100,1200));
        
        setInterval(()=>{
          el.style.transition = 'none';
          el.style.top = rand(-30,-5)+'vh';
          el.style.left = rand(0,95)+'vw';
          el.style.opacity = String(rand(0.8,1));
          el.style.transform = `rotate(${rand(-30,30)}deg)`;
          void el.offsetWidth;
          el.style.transition = `top ${dur}s linear, left ${dur}s ease-in-out, transform ${dur}s linear, opacity ${dur}s linear`;
          setTimeout(()=>{
            el.style.top = '110vh';
            el.style.left = rand(-10,105)+'vw';
            el.style.transform = `rotate(${rand(90,720)}deg) scale(${rand(0.7,1.2)})`;
            el.style.opacity = '0';
          },50);
        }, (dur+rand(2,6))*1000);
        
        leafContainer.appendChild(el);
      }
    })();

    let currentUser = null;
    let currentProfile = null;

    // Format date function
    function formatDate(dateString) {
      if (!dateString) return 'Today';
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('bn-BD', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (e) {
        return 'Today';
      }
    }

    // Update user interface with profile data
    function updateUserInterface(profile) {
      if (!profile) return;

      // Basic user info
      document.getElementById('userName').textContent = profile.fullName || 'Donor';
      document.getElementById('userEmail').textContent = profile.email || '';
      
      // Avatar initials
      const initials = (profile.fullName || 'U')
        .split(' ')
        .filter(Boolean)
        .slice(0, 2)
        .map(n => n[0].toUpperCase())
        .join('') || 'U';
      document.getElementById('avatarInitials').textContent = initials;

      // Stats
      document.getElementById('donationCount').textContent = profile.donationCount || '0';
      document.getElementById('bloodGroup').textContent = profile.bloodGroup || '--';
      document.getElementById('memberSince').textContent = formatDate(profile.createdAt);

      // Availability status
      const availabilityStatus = document.getElementById('availabilityStatus');
      const statusText = document.getElementById('statusText');
      
      if (profile.available) {
        availabilityStatus.className = 'availability-status available';
        statusText.textContent = 'Available for Donation';
      } else {
        availabilityStatus.className = 'availability-status unavailable';
        statusText.textContent = 'Currently Unavailable';
      }
    }

    // Toggle availability
    async function toggleAvailability() {
      if (!currentUser || !currentProfile) return;
      
      try {
        const newAvailability = !currentProfile.available;
        const toggleBtn = document.getElementById('toggleAvailabilityBtn');
        const originalText = toggleBtn.innerHTML;
        
        // Show loading state
        toggleBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Updating...';
        toggleBtn.disabled = true;
        
        await updateAvailability(currentUser.uid, newAvailability, currentProfile.role);
        
        // Update local profile and UI
        currentProfile.available = newAvailability;
        updateUserInterface(currentProfile);
        
        // Show success feedback
        toggleBtn.innerHTML = '<span class="btn-icon">‚úÖ</span> Updated!';
        setTimeout(() => {
          toggleBtn.innerHTML = originalText;
          toggleBtn.disabled = false;
        }, 1500);
        
      } catch (error) {
        console.error('Error updating availability:', error);
        alert('Error updating availability. Please try again.');
        const toggleBtn = document.getElementById('toggleAvailabilityBtn');
        toggleBtn.disabled = false;
        toggleBtn.innerHTML = '<span class="btn-icon">üîÑ</span> Toggle Availability';
      }
    }

    // Auth check and user info
    onAuthChanged(async (user) => {
      if (!user) {
        window.location.href = 'donor_login.html';
        return;
      }
      
      currentUser = user;
      
      try {
        // Show loading state
        document.getElementById('userName').textContent = 'Loading...';
        document.getElementById('userEmail').textContent = 'Loading...';
        
        const profile = await getUserProfile(user.uid);
        
        if (profile) {
          currentProfile = profile;
          updateUserInterface(profile);
        } else {
          // If no profile found, show basic info
          document.getElementById('userName').textContent = user.displayName || user.email;
          document.getElementById('userEmail').textContent = user.email;
          document.getElementById('avatarInitials').textContent = 
            (user.displayName || user.email[0] || 'U').toUpperCase();
        }
      } catch (error) {
        console.error('Error fetching profile:', error);
        document.getElementById('userName').textContent = user.displayName || user.email;
        document.getElementById('userEmail').textContent = user.email;
      }
    });

    // Event Listeners
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      await logoutUser();
    });

    document.getElementById('toggleAvailabilityBtn').addEventListener('click', toggleAvailability);

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+L for logout
      if (e.ctrlKey && e.key === 'l') {
        e.preventDefault();
        document.getElementById('logoutBtn').click();
      }
      // Space bar for toggling availability
      if (e.key === ' ' && e.target === document.body) {
        e.preventDefault();
        document.getElementById('toggleAvailabilityBtn').click();
      }
    });

    // Add service worker registration for PWA capabilities (optional)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  </script>
</body>
</html>